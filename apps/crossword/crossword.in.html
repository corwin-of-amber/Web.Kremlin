<script src="../../reload.js"></script>

<%= jquery %>
<%= hashmap %>
  <style>
    table { border-collapse: collapse; }
    td { width: 1cm; height: 1cm; 
      border: 1px solid black;
      position: relative;
    }
    td i { top: 0; right: 0; 
      position: absolute; 
      font-style: normal;
      font-size: smaller;
    }
    td.black { background: black; }
    td.highlit { background: #fffff0; }
    td p { margin: 0; text-align: center; 
      -webkit-user-modify: read-write;
    }
  </style>
  <body>
    <table id="crossword">
    </table>
  </body>
  <script type="text/ls">
    cwdata =
      idx:
        1:  1: 7 3: 6 5: 5 7: 4 8: 3 9: \x 11: 2 13: 1
        2:  2: \x 4: \x 6: \x 8: \x 9: 8 10: \x 12: \x
        3:  3: 10 4: \x 13: 9
        4:  2: \x 4: \x 5: \x 6: \x 8: \x 10: \x 12: \x
        5:  1: \x 5: 13 9: 12 10: \x 13: 11
        6:  1: 14 2: \x 3: \x 4: \x 6: \x 8: \x 10: \x 12: \x
        7:  3: 17 6: 16 7: \x 13: 15
        8:  2: \x 4: \x 6: \x 7: 18 8: \x 10: \x 11: \x 12: \x
        9:  3: 21 4: \x 11: 20 12: 19 13: \x
        10:  2: \x 4: \x 6: \x 8: \x 9: \x 10: \x 12: \x 13: 22
        11:  9: 24 10: \x 13: 23
        12:  2: \x 4: \x 6: \x 8: \x 10: \x 12: \x
        13:  4: 26 5: \x 13: 25
      get: ([row, col]) ->
        if cwdata.idx[row]
          that[col]
    userdata =
      fillin: new HashMap()
      save: -> localStorage.setItem "userdata", \
                   JSON.stringify userdata
      load: ->
        for own k,v of JSON.parse localStorage["userdata"]
          userdata[k] <<< v
    window.cwdata = cwdata
    window.userdata = userdata
  </script>
  <script type="text/ls">
  mcell =
    style: (td) ->
      [i,j] = td.data \rowcol
      if cwdata.idx[i]
        if v = that[j]
          if v == "x"
            td.add-class \black
          else
            td.append ($ "<i>" .text v)
      td.append ($ "<p>" .text "")
    events: (td) ->
      td.click -> $(this).find 'p' .focus!
      td.focusin -> 
        if ! mcell.highlight-sequence $(this)
          mcell.toggle-dir!
          mcell.highlight-sequence $(this)
      td.dblclick ->
         mcell.toggle-dir!
         mcell.highlight-sequence $(this)
      td.keydown (e) ->
        switch e.which
        case 39 then   mcell.move $(this), \right
        case 37 then   mcell.move $(this), \left
        case 40 then   mcell.move $(this), \down
        case 38 then   mcell.move $(this), \up
        case 8
          $(this).find 'p' .text ''
      td.keypress ->
        $(this).find 'p' .text ''
      td.on \input \p ->
        # persist the change
        txt = $(this).text!
        console.log $(this).parent!data \rowcol
        userdata.fillin.set ($(this).parent!data \rowcol), txt
        userdata.save!
        # advance
        if $(this).text! != ''
          mcell.move $(this).parent!, mcell.sequence-dir
    get: (rowcol) ->
      eq = (a, b) -> a[0] == b[0] && a[1] == b[1]
      return $ \td .filter -> eq ($(this).data \rowcol), rowcol
    get-neighbour: (td, drow, dcol) ->
      [i,j] = td.data \rowcol
      i += drow; j += dcol
      return mcell.get [i,j]
    move: (td, dir) ->
      switch dir
      case 'right' then  td.next!.find 'p' .focus!
      case 'left' then   td.prev!.find 'p' .focus!
      case 'down'
        (mcell.get-neighbour td, 1, 0) .find 'p' .focus!
      case 'up'
        (mcell.get-neighbour td, -1, 0) .find 'p' .focus!
    sequence-dir: "left"
    toggle-dir: ->
      d = {'left': 'down', 'down': 'left'}
      mcell.sequence-dir = d[mcell.sequence-dir]
    highlight-sequence: (td) ->
      $ \.highlit .remove-class \highlit
      at = td.data \rowcol
      thru = (f) ->
        _td = td; _at = e = at
        while _td.length > 0 && (cwdata.get _at) != \x
          _td.add-class \highlit; e = _at
          _at = f _at; _td = mcell.get _at
        e
      if mcell.sequence-dir == "left"
        s = thru (at)->[at[0], at[1]+1]
        e = thru (at)->[at[0], at[1]-1]
      else
        s = thru (at)->[at[0]+1, at[1]]
        e = thru (at)->[at[0]-1, at[1]]
      eq = (a, b) -> a[0] == b[0] && a[1] == b[1]
      ! eq s, e
  window.mcell = mcell
  </script>
  <script type="text/ls">
    cw = $ \#crossword
    for i in [1 to 13]
      tr = $ "<tr>"
      for j in [1 to 13]
        td = $ "<td>"
        td.data 'rowcol', [i,j]
        mcell.style td
        mcell.events td
        tr.append (td)
      cw.append tr
      
    # Re-read previously filled-in letters
    userdata.load!
    userdata.fillin.for-each (v, k) ->
      mcell.get k .find 'p' .text v
  </script>
  <%= livescript %>
</html>